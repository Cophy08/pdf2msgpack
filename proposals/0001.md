# Initial proposal for pdf2msgpack

Started: 2016/04/12
Status: RFC; Prototype implementation in progress.

This is a proposal to build a program for exporting content from PDFs into an
easy to read format.

# Architecture

Two parts:

1. Producer ("pdf2msgpack")
2. Consumer (e.g. pdftables)

#### Key concerns:

* Fast to develop
* Simplicity
  - Easy to run
  - Easy to develop
  - Easy to parse output
  - Conceptually simple
* Output should be reasonably compact, i.e, try to reduce duplication present the postscript stream.
  - E.g (SET COLOR RED) (SET COLOR RED) (DRAW CHARACTER X)
    should be efficiently represented.
  - This is a fairly substantial concern because the streams in general contain
    a lot of noise and no-ops.
  - This is a concern not just for speed but for downstream consumers.
* Slow moving
  - Once developed, this project should not require frequent updates.
  - We can make releases of this binary which we expect to use for a long time.

#### Minor concerns:

* Runtime execution speed
  - It should run at a minimum speed of 10 pages/second, to ensure we can
    maintain the current speed of PDFTable's output.
    This should not be difficult to attain.
* Extensibility
  - If we decide we want to dump more things out of the PDF, this should be
    easily achievable without requiring a complete rewrite or turning the
    format into a big mess.
  - Ideally, be forward compatible. But I consider this optional for now.
* Safety
  - It should be demonstrably secure. Ideally, by dropping all privileges using
    seccomp() or the like. The feasibility of this is not clear at this point,
    since we don't know how much poppler does and if it can be persuaded to do
    less.

#### Non-concerns:

None yet. Some things might get moved here.

### Tradeoffs

How much work do we want to do in pdf2msgpack vs in the consumer of the output?

Two extremes:

* All consumer - consumer has to compute everything
  - pdf2msgpack could dump a raw stream of all graphics operations.
  - consumer can pick and choose
  - consumer has to do work to recover what it wants
  - less C++ code to write; more work if writing a new consumer

* All producer - pdf2msgpack does everything
  - have to write more C++ code; less work for consumers

Do we buffer all the things we see on the page before we write them out, or is
it better to write them as we see them?

#### Writing out as we go

Write out elements as they come.

* Pro: Small amount of logic required in producer
* Con: More complicated logic in consumer

Difficult because it's hard to tell for each element if it is
redundant and can be dropped.

#### Buffering pages

Build a representation of elements on the page.

# Possible Format

* Can be extended for new graphics primitives
* Simple producer

Unsolved problems:

* How to write out transformation matrices and styling?

```
Message = oneOrMore(Document)
        : ######### TODO: NOT Implemented #########

Document = DocumentMetadata + PageCount + oneOrMore(Page) + "EndOfDocument"

DocumentMetadata = Map(all fields optional)
         : Example: {Creator: Adobe Foobar}
         : ######### TODO: NOT Implemented #########
         : Implemented fields: none yet.

PageCount = Integer
          : TODO: NOT Implemented

Page = PageMetadata + zeroOrMore(GraphicsOperation) + "EndOfPage"

PageMetadata = {key: value}...

GraphicsOperation = Glyph | Line | Path | Rect

Glyph = ["G", x1, y1, x2, y2, content]
x1, y1, x2, y2 : co-ordinates.

Path = ["P", Mode, [Path instructions...]]
Line = ["L"]
```
